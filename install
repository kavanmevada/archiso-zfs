#!/bin/bash
echo "Starting Installer"

wipefs -af /dev/vda
sgdisk -a1 -n1:24K:+1000K -t1:EF02 /dev/vda
sgdisk     -n2:1M:+512M   -t2:EF00 /dev/vda
sgdisk     -n3:0:0        -t3:BF00 /dev/vda

sleep 5

$(ls -al /dev/disk/by-partuuid | awk '{ print "export " $11 "=" $9}' | sed 's/..\/..\///g' | sed -e '1,3d')

BOOT=/dev/disk/by-partuuid/$vda2
ROOT=/dev/disk/by-partuuid/$vda3
HOSTNAME=workstation

POOLS=( $(zpool list | awk '{ print $1 }' | sed -e '1d') )


if [ "${#POOLS[@]}" -eq "0" ]; then
mkdosfs -F 32 -s 1 -n EFI $BOOT

zpool create -f -o ashift=12           \
             -O acltype=posixacl       \
             -O relatime=on            \
             -O xattr=sa               \
             -O dnodesize=legacy       \
             -O normalization=formD    \
             -O mountpoint=none        \
             -O canmount=off           \
             -O devices=off            \
             -O compression=lz4        \
             -R /mnt                   \
             rpool $ROOT

echo "rpool created!"

fi


zfs create -o canmount=off -o mountpoint=none rpool/data
zfs create -o canmount=off -o mountpoint=none rpool/ROOT


zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/default
zfs mount rpool/ROOT/default

zfs create -o mountpoint=/home rpool/data/home
zfs create -o mountpoint=/root rpool/data/home/root
chmod 700 /mnt/root

zfs create -o mountpoint=/var -o canmount=off     rpool/var
zfs create                                        rpool/var/log

zfs create -o mountpoint=/var/lib -o canmount=off rpool/var/lib
zfs create                                        rpool/var/lib/libvirt
zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/var/lib/docker
zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/var/lib/nfs

zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/tmp

zpool export rpool
zpool import -d /dev/disk/by-partuuid -R /mnt rpool -N
zpool set bootfs=rpool/ROOT/default rpool
zpool set cachefile=/etc/zfs/zpool.cache rpool
zfs mount -a

mkdir -p /boot/efi
mount $BOOT /boot/efi
pacstrap /mnt base linux linux-firmware base-devel grub efibootmgr
genfstab -U -p /mnt >> /mnt/etc/fstab

mkdir /mnt/etc/zfs
cp /etc/zfs/zpool.cache /mnt/etc/zfs/zpool.cache


cat << EOF | arch-chroot /mnt /bin/sh
timedatectl set-timezone Europe/Paris
sed -i '/en_US.UTF-8/s/^#//g' /etc/locale.gen
locale-gen
echo LANG=en_GB.UTF-8 > /etc/locale.conf
echo $HOSTNAME > /etc/hostname
echo '127.0.0.1	localhost' > /etc/hosts
echo '::1		localhost' >> /etc/hosts
echo '127.0.1.1	'$HOSTNAME >> /etc/hosts
echo "root:root" | chpasswd
grub-install --target=x86_64-efi --bootloader-id=GRUB --efi-directory=/boot/efi
grub-mkconfig -o /boot/grub/grub.cfg
EOF
