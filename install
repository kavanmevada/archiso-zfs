#!/bin/bash
echo "Starting Installer"

wipefs -af /dev/vda
sgdisk --zap-all /dev/vda

sgdisk -a1 -n1:24K:+1000K -t1:EF02 /dev/vda
sgdisk     -n2:1M:+512M   -t2:EF00 /dev/vda
sgdisk     -n3:0:0        -t3:BF00 /dev/vda

sleep 5

mkfs.vfat /dev/vda2

# Check zfs module loaded or not.
test -n "$(grep -e "^zfs " /proc/modules)" && echo "zfs Loaded" || (echo "zfs Not loaded" && exit)

zpool create -f -o ashift=12 \
  -O acltype=posixacl \
  -O relatime=on \
  -O xattr=sa \
  -O dnodesize=legacy \
  -O normalization=formD \
  -O mountpoint=none \
  -O canmount=off \
  -O devices=off \
  -R /mnt \
  zroot /dev/vda3
  
  
zfs create -o mountpoint=none zroot/data
zfs create -o mountpoint=none zroot/ROOT
zfs create -o mountpoint=/ -o canmount=noauto zroot/ROOT/default
zfs create -o mountpoint=/home zroot/data/home

zfs create -o mountpoint=/var -o canmount=off zroot/var
zfs create zroot/var/log

zfs create -o mountpoint=/var/lib -o canmount=off zroot/var/lib
zfs create zroot/var/lib/libvirt
zfs create zroot/var/lib/docker

zpool export zroot
zpool import -d /dev/vda3 -R /mnt zroot -N

zfs mount zroot/ROOT/default
zfs mount -a

zpool set bootfs=zroot/ROOT/default zroot
zpool set cachefile=/etc/zfs/zpool.cache zroot
mkdir -p /mnt/{etc/zfs,boot/efi}
cp /etc/zfs/zpool.cache /mnt/etc/zfs/zpool.cache

mount /dev/vda2 /mnt/boot/efi

pacman -Syy
pacstrap /mnt base base-devel linux linux-firmware linux-headers nano vim grub efibootmgr gdm gnome-shell gnome-control-center nautilus gnome-terminal 
genfstab -U -p /mnt | sed -e '/^zroot/d;/^#\ zroot/d' > /mnt/etc/fstab

curl -L https://git.io/Jsfw2 > /mnt/etc/pacman.d/mirrorlist-archzfs
tee -a /mnt/etc/pacman.conf <<- 'EOF'

#[archzfs-testing]
#Include = /etc/pacman.d/mirrorlist-archzfs

[archzfs]
Include = /etc/pacman.d/mirrorlist-archzfs
EOF

cat << EOF | arch-chroot /mnt /bin/sh
timedatectl set-timezone Europe/Paris
sed -i '/en_US.UTF-8/s/^#//g' /etc/locale.gen
locale-gen
echo LANG=en_GB.UTF-8 > /etc/locale.conf
echo workstation > /etc/hostname
echo '127.0.0.1	localhost' > /etc/hosts
echo '::1		localhost' >> /etc/hosts
echo '127.0.1.1	workstation' >> /etc/hosts


sed -i'' 's/filesystems\ keyboard\ fsck/keyboard\ zfs\ filesystems/g' /etc/mkinitcpio.conf
pacman -Sy --needed --noconfirm zfs-dkms glibc
# mkinitcpio -p linux

sed -i'' 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX="root=ZFS=zroot\/ROOT\/default"/g' /etc/default/grub

curl -L https://archzfs.com/archzfs.gpg |  pacman-key -a -
pacman-key --lsign-key $(curl -L https://git.io/JsfVS)


grub-install --target=x86_64-efi --bootloader-id=ARCHLINUX --efi-directory=/boot/efi
grub-mkconfig -o /boot/grub/grub.cfg

systemctl enable zfs-import-cache
systemctl enable zfs-import-scan
systemctl enable zfs-mount
systemctl enable zfs-share
systemctl enable zfs-zed
systemctl enable zfs.target


echo "root:root" | chpasswd
EOF

umount /mnt/boot/efi
zfs umount -a
zpool export zroot
