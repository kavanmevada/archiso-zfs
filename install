#!/bin/bash
echo "Starting Installer"

$(ls -al /dev/disk/by-partuuid | awk '{ print "export " $11 "=" $9}' | sed 's/..\/..\///g' | sed -e '1,3d')

ROOT=/dev/disk/by-partuuid/$vda3


POOLS=( $(zpool list | awk '{ print $1 }' | sed -e '1d') )


if [ "${#POOLS[@]}" -eq "0" ]; then

zpool create -f -o ashift=12           \
             -O acltype=posixacl       \
             -O relatime=on            \
             -O xattr=sa               \
             -O dnodesize=legacy       \
             -O normalization=formD    \
             -O mountpoint=none        \
             -O canmount=off           \
             -O devices=off            \
             -O compression=lz4        \
             -R /mnt                   \
             rpool $ROOT

echo "rpool created!"

fi


zfs create -o canmount=off -o mountpoint=none rpool/ROOT
zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/default
zfs mount rpool/ROOT/default

zfs create                                 rpool/home
zfs create -o mountpoint=/root             rpool/home/root
chmod 700 /mnt/root
zfs create -o canmount=off                 rpool/var
zfs create -o canmount=off                 rpool/var/lib
zfs create                                 rpool/var/log
zfs create                                 rpool/var/spool

zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/var/cache

zfs create                                 rpool/opt
zfs create                                 rpool/srv

zfs create -o canmount=off                 rpool/usr
zfs create                                 rpool/usr/local
zfs create                                 rpool/var/games
zfs create                                 rpool/var/mail
zfs create                                 rpool/var/snap
zfs create                                 rpool/var/www
zfs create                                 rpool/var/lib/AccountsService
zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/var/lib/docker
zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/var/lib/nfs


mkdir /mnt/run
mount -t tmpfs tmpfs /mnt/run
mkdir /mnt/run/lock

zfs create -o com.archlinux.zsys:auto-snapshot=false  rpool/tmp
chmod 1777 /mnt/tmp
